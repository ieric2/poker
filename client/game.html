<html>

<head>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="icon" href="/favicon.ico?v=1.1">
    <link rel="stylesheet" type="text/css" href="/client/game.css">



    <script>
    </script>
</head>


<body>
    <div class="gameTitleTab">
        <h2>POKER</h2>
    </div>
    <div class="flex-container" id="gameScreen" style="width:100%; height:90%; display:flex; flex-direction:row; flex-wrap:nowrap; align-items:flex-start;">
        <div class="container" style="width:25%;height:100%;">
            <div style="height:20%; width:100%">
                <text>
                Players In Game:
                </text>

                <div id="playerArray" style="width: 100%; overflow-y:scroll;">
                </div>
            </div>
            <div class="playHistory" id="playHistory">
                <div class="playHistoryLabel">
                Play History
                </div>
            </div>
        </div>

        <div class="container" style="width:50%;height:100%; display:flex; flex-direction:column;">
            <container class="cardTable" id="cardTable">
                <div id='pot' style="color:white;">
                    0
                </div>
                <div class='cardRow'>
                    <img id='community0' class='card' src="../client/images/cards/card_back.svg">
                    <img id='community1' class='card' src="../client/images/cards/card_back.svg">                
                    <img id='community2' class='card' src="../client/images/cards/card_back.svg">                
                    <img id='community3' class='card' src="../client/images/cards/card_back.svg">                
                    <img id='community4' class='card' src="../client/images/cards/card_back.svg">            
                </div>
                <div class='cardRow'>
                    <img id='hand0' class='card' src="../client/images/cards/card_back.svg">
                    <img id='hand1' class='card' src="../client/images/cards/card_back.svg">
                </div>
                <div id='balance' style="color:white;">
                    200
                </div>
            </container> 

            <div style="height:20%; width:100%;">
                <form id='bettingForm' class=form-group action="result.php" method="post" style="display:none">
                    <label for="betInput"> Make Your Bet: </label>
                    <input type="number" id='betInput' name='betInput' min='0' max='200' value='1'>
                    <button class="btn btn-primary btn-lg" type="button" onclick="playTurn()">Bet</button>
                </form>
                <button id="startGameButton" class="btn btn-primary btn-lg centerScreen" type="button" onclick="startGame()">Start Game</button>
            </div>
            <text>Made by: ieric, cathxu, anayatiffany</text>

        </div>

        <div class="container" style="width:25%; height:100%;background-color: #e8e8e8;">
            <div style="height:100%">
                <div id="chat" style="height:93%; overflow-y:scroll;">
                </div>

                <form id="chatForm" style="width:95%;">
                    <input id="chatInput" type="text" class="form-control" style="width:100%">
                </form>
            </div>
            
        </div>
    </div>


    <script>
        var cards = {}
        var gameId = window.location.pathname.split("/")[2]
        const bettingForm = document.getElementById("bettingForm")
        const betInput = document.getElementById('betInput')
        const startGameButton = document.getElementById("startGameButton")

        const chatForm = document.getElementById("chatForm");
        const chatInput = document.getElementById("chatInput");
        const balance = document.getElementById("balance");
        const pot = document.getElementById("pot");


        // const playerTurn = document.getElementById("playerTurn");
        const playHistory = document.getElementById("playHistory");
        const playerArrayTag = document.getElementById("playerArray");
        const cardTable = document.getElementById("cardTable");
        const community0 = document.getElementById("community0");
        const community1 = document.getElementById("community1");
        const community2 = document.getElementById("community2");
        const community3 = document.getElementById("community3");
        const community4 = document.getElementById("community4");

        const hand0 = document.getElementById("hand0");
        const hand1 = document.getElementById("hand1");

        var communityCards = [community0, community1, community2, community3, community4]
        var handCards = [hand0, hand1];

        var gameInProgress = false;   

        const socket = io();
        var session_id;
        let data = sessionStorage.getItem('sessionId');
        if (data == null) {
            session_id = null
        } else {
            session_id = data//when we connect n times 
        }
        socket.emit('startSession', {  sessionId: session_id, gameId: gameId })
        socket.emit('roomEntered', {gameId: window.location.pathname.split('/')[2]})     

        function startGame(){
            console.log("starting game");
            socket.emit('startGame', {gameId: gameId});
        }

        function playTurn(){
            var bet = betInput.value;
            socket.emit("playTurn", {bet: bet, gameId: gameId});
        }

        function castDoubt(){
            socket.emit("checkHand", {gameId: gameId});
        }

        function displayHandCard(src, index) {
            handCards[index].src = src;
        }

        function displayCommunityCard(src, index) {
            communityCards[index].src = src;
        }

        socket.on('sessionAck', function(data){
            sessionStorage.setItem('sessionId', data.sessionId);
            id = data.sessionId
        })

        socket.on("resetState", function(data){

        })


        socket.on("newHand", function(data){
            let cards = data.cards;
            for (let i = 0; i < cards.length; i++) {
                src = "../client/images/cards/"+cards[i]+".svg"
                displayHandCard(src, i);
            }
            for (let i = 0; i < 5; i++) {
                src = "../client/images/cards/card_back.svg"
                displayCommunityCard(src, i);
            }
        })

        socket.on('flop', data => {
            let cards = data.cards;
            for (let i = 0; i < cards.length; i++) {
                src = "../client/images/cards/"+cards[i]+".svg"
                displayCommunityCard(src, i);
            }        
        })

        socket.on('turn', data => {
            let cards = data.cards;
            src = "../client/images/cards/"+cards[0]+".svg"
            displayCommunityCard(src, 3);
        })

        socket.on('river', data => {
            let cards = data.cards;
            src = "../client/images/cards/"+cards[0]+".svg"
            displayCommunityCard(src, 4);
        })

        socket.on("clearChat", function(){
            chat.innerHTML = "";
        })

        socket.on("addToChat", function(data){
            chat.innerHTML += '<div>' + data + '</div>';
        });

        socket.on('setBalance', data => {
            balance.innerHTML = data.balance;
        })

        socket.on('setPot', data => {
            pot.innerHTML = data.pot;
        })

        socket.on("updateGame", function(data){
            console.log('updating game')
            playHistory.innerHTML +=  '<div>' + data.text + '</div>';
        })

        socket.on("displayPlayButtons", function(){
            gameInProgress = true;
            bettingForm.style.display = "block"
            startGameButton.style.display = "none"
        })

        socket.on("updatePlayerArray", function(data){
            playerArrayTag.innerHTML = "";
            for (i in data.playerNames){
                if (i == data.playerTurn){
                    data.playerNames[i] = '<b>' + data.playerNames[i] + '</b>';
                }
                if (data.playerIds[i] == session_id){
                    playerArrayTag.innerHTML += '<div>' + data.playerNames[i] + '<b> [ME] </b>' + '</div>';
                }
                else{
                    playerArrayTag.innerHTML += '<div>' + data.playerNames[i] + '</div>';
                }
            }
        })

        chatForm.onsubmit = function(e){
            e.preventDefault();
            console.log(chatInput.value);
            socket.emit('chat', {text: chatInput.value, gameId: gameId});
            chatInput.value = "";
        }

    </script>
</body>



</html>
